---
title: "main"
output: html_document
date: "2023-01-27"
author: "Leroy Bondhus"
---

```{r set up dir structure}
dirs <- list(data="./data/",
             results = "./results/",
             tables = "./results/tables/",
             figures = "./results/figures/",
             temp_data ="/u/scratch/l/leroybon/chrom_mod_expr_landscape/")
for(dir in dirs){
  if(!dir.exists(dir)){dir.create(dir)}
};rm(dir)

files <- list()
date <- format(Sys.time(),"%Y%m%d")
```

```{r load libraries}
req_packages <- list(
  standard = c("BiocManager","doParallel","ggplot2","stringr"),
  biocmanager = c("Gviz","biomaRt")
)
for(std_package in req_packages$standard ){
  if(!require(std_package, quietly=T, character.only=T)){install.packages(std_package)}
};rm(std_package)
for(bioc_package in req_packages$biocmanager ){
  if(!require(bioc_package, quietly=T, character.only=T)){BiocManager::install(bioc_package)}
};rm(bioc_package)
rm(req_packages)
```


```{r, organize ontologies}


ontos <- list()
ontos$go = list(
  URL = "http://purl.obolibrary.org/obo/go.obo"
)

files$go_obo <- paste0(dirs$temp_data,"go.obo")
download.file(ontos$go$URL,files$go_obo)

##### read in and set up ontology ####
con <- file(files$go_obo,open="r")
num_terms <- 0
while(TRUE){
  line = readLines(con,n=1)
  if(length(line)==0){break}
  num_terms <- num_terms + grepl("^\\[Term\\]$",line)
}
close(con)

ontos$go$ont <- list(
  id=character(length = num_terms ),
  name=character(length = num_terms ),
  namespace = character(length = num_terms ),
  parents = vector("list", num_terms),
  children = vector("list", num_terms),
  is_obsolete = rep(FALSE, num_terms)
)

term_num <- 0
con <- file(files$go_obo,open="r")
while(TRUE){
  line = readLines(con,n=1)
  if(length(line)==0){
    break
  } else if(grepl("^\\[Term\\]$",line)){
    term_num <- term_num + 1
  } else if(grepl("^id:.*GO:",line)){
    ontos$go$ont$id[term_num] <- str_extract(line, "GO:[0-9]+")
  } else if(grepl("^name:",line)){
    ontos$go$ont$name[term_num] <- str_remove(line, "^name:[[:space:]]")
  } else if(grepl("^namespace:",line)){
    ontos$go$ont$namespace[term_num] <- str_remove(line, "^namespace:[[:space:]]")
  } else if(grepl("^is_a:",line)){
    ontos$go$ont$parents[term_num][[1]] <- c(ontos$go$ont$parents[term_num][[1]], str_remove(str_remove(line, "^is_a:[[:space:]]"),"[[:space:]]*!.*")) 
  } else if(grepl("^is_obsolete: true",line)){
    ontos$go$ont$is_obsolete[term_num] <- TRUE 
  }
}
close(con)

### replace is_a with parents
### add children attribute to each term for ease of navigation up and down ontology
for(i in 1:length(ontos$go$ont$id)){
  which <- which(is.element(ontos$go$ont$id, ontos$go$ont$parents[i][[1]]))
  if(length(which)==0){next}
  for(el in which){
    ontos$go$ont$children[el][[1]] <- unique(c(ontos$go$ont$children[el][[1]], ontos$go$ont$id[i] ))
  }
}

##### done: read in and set up ontology ####

## uberon
## hpo
## go # MF
## go # CC
## go # BP

```


```{r, organize gene sets}
ensembl <- useEnsembl(biomart="ensembl", dataset="hsapiens_gene_ensembl")
# genes <- getBM(attributes=c('chromosome_name','start_position','end_position','strand',
#                             'ensembl_gene_id',"external_gene_name"),
#                  #filters = list('biotype'='protein_coding'),
#                  mart = ensembl, useCache = F)

genes <- getBM(attributes=c('chromosome_name','start_position','end_position','strand',
                            'ensembl_gene_id',"external_gene_name","go_id","name_1006"),
                 #filters = list('biotype'='protein_coding'),
                 mart = ensembl, useCache = F)

term_sets <- list()
term_sets$chromatin_go_terms <- c("histone acetyltransferase activity",
                                  "histone deacetylase activity",
                                  "histone methyltransferase activity",
                                  "histone demethylase activity",
                                  "histone ubiquitin ligase activity",
                                  "histone deubiquitinase activity",
                                  "histone kinase activity",
                                  "histone phosphatase activity",
                                  "chromatin remodeling",
                                  "chromatin organization",
                                  "DNA-methyltransferase activity",
                                  "DNA demethylase activity"
                                  )

## for each term in chrom_go_terms, check which genes are associated with term (and any of it's descendants)
## for each term, get all descendant terms, 

gene_sets <- list()
## human
## mouse
## zebrafish
## celegans
## fly 
## chromatin modifier


```

```{r, look at basic chromatin modifier summary statistics}


### look at pLI

temp <- tempfile()
download.file("https://storage.googleapis.com/gcp-public-data--gnomad/release/2.1.1/constraint/gnomad.v2.1.1.lof_metrics.by_gene.txt.bgz",temp)
lof_metrics <- read.table( temp, skip=0, header = TRUE, sep = "\t")

temp <- tempfile()
download.file("http://geneontology.org/gene-associations/goa_human_complex.gaf.gz",temp)
go_complex_metrics <- read.table( temp, skip=0, header = TRUE, sep = "\t")


# temp <- tempfile()
# download.file("http://ftp.ebi.ac.uk/pub/databases/intact/complex/current/psi30/human.zip",temp)
# complex_metrics <- read.table( temp, skip=0, header = TRUE, sep = "\t")
```



```{r, organize datasets}

dataset_list <- list()
## encode (has uberon, standard format)
## gtex (has uberon, standard format)
## sra (mixed format)


```

