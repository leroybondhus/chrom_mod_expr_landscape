---
title: "HPA + GTEX"
output: html_document
---
```{r libraries}
library(matrixStats)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(readxl)
library("Hmisc")
library(ComplexHeatmap)
library("circlize")
library("RColorBrewer")
library(gdata)
library(igraph)

```


```{r read in data}
HPA_tissue_exp <- read.delim("~/Downloads/HPA_tissue_exp.tsv")

#read in modifier lists
kmt <- t(read_excel("~/Desktop/GTEX/chromatin_modifiers_table.xlsx", 2))
kdm <- t(read_excel("~/Desktop/GTEX/chromatin_modifiers_table.xlsx", 3))
kat <- t(read_excel("~/Desktop/GTEX/chromatin_modifiers_table.xlsx", 4))
hdac <- t(read_excel("~/Desktop/GTEX/chromatin_modifiers_table.xlsx", 5))


```

```{r modify HPA}
#convert detection levels to numbers
HPA_exp <- HPA_tissue_exp
for(i in 1:length(HPA_exp$Level)) {
        if (HPA_exp$Level[i] == "Not detected") {
HPA_exp$Level[i]=0
        } 
    else if (HPA_exp$Level[i]== "Low") {
HPA_exp$Level[i]=1
    } 
    else if (HPA_exp$Level[i]== "Medium") {
HPA_exp$Level[i]=2
    } 
    else {
HPA_exp$Level[i]=3
} 
}

HPA_exp <- HPA_exp[,-c(1,4,6)]
HPA_exp$Level <- as.numeric(HPA_exp$Level)
hist(HPA_exp$Level)

```


```{r filter for modifiers in HPA exp}
#filter for kmt
HPA_filter <- filter(HPA_exp, Gene.name %in% kmt| Gene.name %in% kdm| Gene.name %in% kat| Gene.name %in% hdac)

HPA_filter2 <- HPA_filter %>% group_by(Tissue, Gene.name) %>% mutate(Level= mean(Level)) %>% unique()
HPA_filter2 <- HPA_filter2 %>% pivot_wider(names_from= Tissue, values_from= Level)
HPA_filter2 <- data.frame(HPA_filter2)
rownames(HPA_filter2) <- HPA_filter2$Gene.name
HPA_filter2 <- HPA_filter2[,-c(1)]
HPA_filter2[is.na(HPA_filter2)] <- 0

```
```{r correlation matrix}
HPA_filter2 <- t(HPA_filter2)
Type <- vector(length= ncol(HPA_filter2))
HPA_filter3 <- rbind(HPA_filter2, Type)

for(i in 1:ncol(HPA_filter3)) {
  if (colnames(HPA_filter3)[i] %in% kmt) {HPA_filter3["Type", i]= "KMT"}
  else if (colnames(HPA_filter3)[i] %in% kdm) {HPA_filter3["Type", i]= "KDM"}
  else if (colnames(HPA_filter3)[i] %in% kat) {HPA_filter3["Type", i]= "KAT"}
  else {HPA_filter3["Type", i]= "HDAC"}
}



HPA.cor <- cor(HPA_filter2, method="pearson")
HPA.cor[is.na(HPA.cor)] <- 0
```
```{r color palette}
#color levels
coul <- brewer.pal(nlevels(as.factor(HPA_filter3["Type",])), "Set2")
my.color <- coul[as.numeric(as.factor(HPA_filter3["Type",]))]
```
```{r network plot}
#Remove lower correlations
network.mx2 <- HPA.cor
network.mx2[network.mx2<0.65] <- 0
#igraph object from matrix
network2 <- graph_from_adjacency_matrix(network.mx2, weighted=T, mode="undirected", diag=F)
par(bg="grey13", mar=c(0,0,0,0))
plot(network2, vertex.size= 5, vertex.label.cex=0.3, vertex.color=my.color, vertex.label.color="white", vertex.frame.color="transparent")
#legend
legend(x=1.2, y=-0.4, legend=paste(levels(as.factor(HPA_filter3["Type",]))), col = coul, bty = "n", pch=20 , pt.cex = 2, cex=1, text.col="white", horiz = F)
```
```{r png}
png(filename= "network_HPA_0.65.png", res=300, width=3000, height=3000)
network2 <- graph_from_adjacency_matrix(network.mx2, weighted=T, mode="undirected", diag=F)
par(bg="grey13", mar=c(0,0,0,0))
plot(network2, vertex.size= 5, vertex.label.cex=0.35, vertex.color=my.color, vertex.label.color="white", vertex.frame.color="transparent")
#legend
legend(x=1.2, y=-0.4, legend=paste(levels(as.factor(HPA_filter3["Type",]))), col = coul, bty = "n", pch=20 , pt.cex = 2, cex=1, text.col="white", horiz = F)
dev.off()

```


```{r resolution}

HPA_round <- round(HPA_filter2, digits=0)

res <- table(c(col(HPA_round)), c(HPA_round))
resm <- rbind(as.numeric(names(res)), res)
rownames(resm) <- colnames(HPA_round)

png(filename= "HPA_expression_counts", res=300, width= 1000, height=3000)
Heatmap(resm, name= "count", cluster_columns= FALSE, row_names_gp = grid::gpar(fontsize = 6), col = colorRamp2(c(0,10,20,30,40,50), brewer.pal(n=6, name="Blues")))
dev.off()


```

