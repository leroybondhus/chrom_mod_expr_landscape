---
title: "ISL_brainspan_analyses"
author: "Isabelle Liu"
date: "2023-08-18"
output: html_document
---

```{r, load in files}
columns_meta <- read.csv(paste0(dirs$data, "brainspan/columns_metadata.csv"))
expression_mat <- read.csv(paste0(dirs$data, "brainspan/expression_matrix.csv"), header = FALSE, row.names = 1)

unique_structures <- unique(columns_meta$structure_name)

uberon_names <- ontos$uberon$ont$name
uberon_ids <- ontos$uberon$ont$id

mapped_ids <- vector(mode = "character", length = length(unique_structures))
# could change into list of character vectors

for (i in 1:length(unique_structures)){
  match = uberon_ids[grep(unique_structures[i], uberon_names)]
  if(length(match) == 0){
    mapped_ids[i] = "NA"
  }
  else{
    mapped_ids[i] = uberon_ids[grep(unique_structures[i], uberon_names)]
  }
}

# manually assign uberon ids for inexact matches
mapped_ids[1] = "UBERON:0016540" # occipital neocortex --> occipital cortex
mapped_ids[2] = "UBERON:0001384" # primary motor-sensory cortex (samples) --> primary motor cortex
mapped_ids[3] = "UBERON:0006107" # amygdaloid complex --> basolateral amygdaloid nuclear complex
mapped_ids[5] = "UBERON:0013553,UBERON:0016538" # posterior (caudal) superior temporal cortex (area 22c) --> Brodmann (1909) area 22, temporal cortex
mapped_ids[6] = "UBERON:0009841" # upper (rostral) rhombic lip --> upper rhombic lip
mapped_ids[9] = "UBERON:0022438" # anterior (rostral) cingulate (medial prefrontal) cortex --> rostral anterior cingulate cortex
mapped_ids[13] = "UBERON:0013551,UBERON:0016538" # inferolateral temporal cortex (area TEv, area 20) --> Brodmann (1909) area 20, temporal cortex
mapped_ids[14] = "UBERON:0002421" # hippocampus (hippocampal formation) --> hippocampal formation
mapped_ids[15] = "UBERON:0000451" # ventrolateral prefrontal cortex --> prefrontal cortex, COULD INCLUDE BRODMANN AREAS BUT NOT DIRECTLY LINKED
mapped_ids[16] = "UBERON:0016530" # parietal neocortex --> parietal cortex
mapped_ids[17] = "UBERON:0016538" # temporal neocortex --> temporal cortex
mapped_ids[18] = "UBERON:0034751" # primary auditory cortex (core) --> primary auditory cortex
mapped_ids[19] = "UBERON:8440010,UBERON:0002436" # primary visual cortex (striate cortex, area V1/17) --> Brodmann (1909) area 17, primary visual cortex
mapped_ids[21] = "UBERON:0001384,UBERON:0013535" # primary motor cortex (area M1, area 4) --> primary motor cortex, Brodmann (1909) area 4
mapped_ids[22] = "UBERON:0006088" # posteroventral (inferior) parietal cortex --> inferior parietal cortex
mapped_ids[23] = "UBERON:0008933" # primary somatosensory cortex (area S1, areas 3,1,2) --> primary somatosensory cortex
mapped_ids[26] = "UBERON:0002739" # mediodorsal nucleus of thalamus --> medial dorsal nucleus of thalamus

struct_to_ids <- cbind(unique_structures, mapped_ids)

```

```{r, add_annotation function}

# modeled off expr_data_setup code
# note that onto <- ontos$uberon$ont also in main or phenotype_summary_analyses
onto <- ontos$uberon$ont

# create vector with uberon IDs in order of columns_meta
mapped_uberon_ids <- vector("list", length(columns_meta$structure_name))

for (i in 1:length(columns_meta$structure_name)){
  mapped_uberon_ids[i] = struct_to_ids[,2] [grep(columns_meta$structure_name[i],struct_to_ids[,1], fixed = TRUE)]
}

# split strings for elements with multiple Uberon IDs
for (i in 1:length(mapped_uberon_ids)){
  mapped_uberon_ids[i] = str_split(mapped_uberon_ids[i], ",")
}

onto$brainspan_cols <- vector("list", length(onto$id))
for(i in 1:length(columns_meta$structure_name)){
  if(i %% 100 == 0){print(i)}
  if(is.na(mapped_uberon_ids[i])){next}
  # iterate through multiple uberon ids per structure
  for(j in 1:length(mapped_uberon_ids[i])){
    onto <- add_annotation(mapped_uberon_ids[[i]][j], onto, "brainspan_cols", i,
                         transitive_relations = c("part_of", "is_a" ))
  }
}

save(onto, file = "./onto.RData")

```

```{r, Uberon onto summary statistics}
# histogram to show avg number of terms per brainspan column
brainspan_terms <- sapply(onto$brainspan_cols,function(x){length(x[[1]])}) # need to fix to get length of list
 # 130 Uberon terms that relate to brainspan data

hist(brainspan_terms[which(brainspan_terms>0)], breaks = 20, main = "Histogram of number of brainspan terms populated")


# # calculate average gene expression per populated brainspan column in ontology
# brainspan_avg_express <- vector("numeric", length(brainspan_terms))
# for(i in 1:length(brainspan_terms)){
#   for(j in 1:length(brainspan_terms[i])){
#     brainspan_avg_express[i] =brainspan_avg_express[i] + sum(expression_mat[j])
#   }
# }

# calculate average gene expression of a row
# rowMeans(expression_mat[,onto$brainspan_cols[24][[1]]])
```

```{r, sort expression matrix by brain structure and development time}
# sort columns_meta by brainspan structure name & then already in age ascending order
sorted_cols <- columns_meta[with(columns_meta, order(structure_name)),]

# sort expression_mat columns based on order from sorted columns_meta
sorted_expression <- expression_mat[sorted_cols$column_num]
```

```{r, heat maps for gene expression over time for each structure}
library(ggplot2)
library(ComplexHeatmap)

# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# 
# BiocManager::install("ComplexHeatmap")

# heatmap of "amygdaloid complex"
sorted_expression <- as.matrix(sorted_expression) # convert to matrix

Heatmap(sorted_expression[,1:33])
```

